# e2es-orchestrator

## Prerequisites

- A storage root folder must be created ( e.g. `C:\PDGS_NAS_folder` ); this is used as a I/O directory for each processor. Internal folder structure must mimic ICD specifications
- A backup root folder must be created (e.g. `C:\data_backups`);  this is used for storing orchestrator's run backups and PAM related files. This folder must contain a `PAM` fodler (e.g. `C:\data_backups\PAM`)
- Each processor must be installed properly ( following processor's release notes / instructions / readme file )
- Each processor must be configured properly
- It is mandatory to test each processor once before use in the orchestration

## Installation

- Install [miniconda](https://docs.conda.io/en/latest/miniconda.html)
- Open anaconda powershell prompt ( find it using the Windows search bar )
- Run command `conda update conda`
- Run command `cd /path/to/e2es-orchestrator`
- Run command `conda env create -f environment.yml`
- Run command `cp configurations.sample.yaml configurations.yaml`

## Configuration

- `start`: identify the workflow starting processor; possible values are listed in 'processors' fields (keys)
- `end`: identify the workflow ending processor; possible values are listed in 'processors' fields (keys); this ending processor cannot sit before the one in 'start' field  (following the order of the list in 'processors' field)
- `PAM` : set to `True` if it is required to run the PAM process in the end or `False` otherwise
- `logLevel`: only for debugging purposes
- `dataRoot`: absolute path to storage folder ( e.g. `C:\PDGS_NAS_folder` )
- `backupRoot`: absolute path to backup folder (e.g. `C:\data_backups`)
- `backupFile`: (optional) filename (without extension) to a backup file in the `backupRoot` generated during a previous run; if present, the orchestrator will load data from this backup into `dataRoot` specific folders before starting a new run
- `workingDirectory`: absolute path to processor delivery folder; internal folder structure must mimic ICD structure 
- `executable` or `script`: relative path to processor executable or python script

### Example
Check `configurations.sample.yaml` to have an example of a working configuration.

## Usage 
- Check the `configurations.yaml` and apply changes according to your needs
### Automatic
- Run the `run.ps1` script in a powershell
### Manual
- Delete `context`, `.snakemake` and `__pycache__` folders if they are present in the `orchestrator` folder
- Open anaconda powershell prompt ( find it using the Windows search bar )
- Run command `cd /path/to/e2es-orchestrator`
- Run command `conda activate e2es-orchestrator`
- Run command `snakemake --cores 1 RUN`

## Troubleshoot
- If any of the processor stops unexpectedly or some other error arise ( e.g. from snakemake ), maybe some transient folders are present in the orchestrator folder. Delete them and try again.
- Backup files must have been generated by the orchestrator. If using manually crafted backup files, the orchstrator could fail.
- Paths which contain spaces usually could cause different problems. It is suggested to work with paths which folder/file names do not contain space characters.


